---
title: "Importance Analysis"
output: html_notebook
---

Calculating Leslie's importance values  to see if I get the same results she does when I compare with her work.

Because we measured trees per plot but seedlings and saplings per circle, we need to calculate importance of trees vs. seedlings/saplings and then add them together to get a species importance value. 

Trees are per plot: One plot = 400m2, which is the same as 1/25 of a hectare; thus multiplying by a factor of 25 converts to trees per hectare.

Seedlings/saplings are per circle; one circle is 10m2 which is 1/1000 of a hectare; multiplying by 1000 gives per hectare. However, we have 3 circles per plot; thus we have 30m2 total and that means multiply by 333.3 to get per hectare.

Prep the workspace
```{r}
rm(list = ls())
library(dplyr)
library(tidyr)
library(ggplot2)
```

Start with one file. It has Leslie's data plus the data from the relevant FE forests.

```{r}
DF<-read.csv("Data/forests.csv")
```

Plot some data and look for issues
```{r}
ggplot(DF, aes(DBH))+
   geom_histogram()
```
Looks like there might be a really big tree or two.  Check them out. 

```{r}
big<-filter(DF, DBH >= 60)
big
```
Two big sugar maples at donnerville.  Reasonable.

Now look at species to see if they are all named correctly. Start by making some factor variables
```{r}
species<-levels(DF$Species)
species
```
Looks good. Though the white birch are likely gray birch.

Get a tree and seed/sap dataframe
```{r}
trees<-filter(DF, Type == "tree")
seedsap<-filter(DF, Type != "tree")
```
We will now step through calculation of IV, first for trees and then repeat the same steps for seedlings/saplings.
##Trees
###Step 1. Density and relative density
Establish area var for trees

```{r}
APP_t<-400 #AreaPerPlot = 400m2 per forest plot
```
Determine number of trees per plot
```{r}
PerP<-trees %>% group_by(Forest, PlotID) %>% summarise(
  treesPerP = length(Species)
)
```
Get total density of trees per plot = #trees/area sampled
```{r}
PerP<-PerP %>% mutate(
  DensPerPlot = treesPerP/APP_t
)
```
Get total density of trees per hectare per forest plot by multiplying DensPerPlot times 25 (the scaling factor for a forest plot)
```{r}
PerP<-PerP %>% mutate(
  DensPerHect=DensPerPlot*25
)
```
Calculate density for each species where density = #trees per area

Start with number of trees by species for each plot
```{r}
ImportancePerPlot<-trees %>% group_by(Forest, PlotID, Species) %>% summarise(
  Number = length(Species)
)
```
And now get density by species
```{r}
ImportancePerPlot<-ImportancePerPlot %>% mutate(
  PlotDensity = Number/APP_t
)
```
Now add the total density per plot to the ImportancePerPlot df so that we can do math with it. 

Use a join to join by forest and plot id and then join PerP to ImportancePerPlot.

```{r}
ImportancePerPlot<-left_join(ImportancePerPlot, PerP, by = c("Forest", "PlotID"))
```
It worked! Now drop a couple of columns and rename a couple to keep things making sense:
```{r}
#drop density per hectare
ImportancePerPlot<-select(ImportancePerPlot, -c(treesPerP,DensPerHect))
#now rename
ImportancePerPlot<-rename(ImportancePerPlot, dens_in_plot = PlotDensity, total_density = DensPerPlot )
```
Now I can calculate relative density for each species 

Relative density = (density for a species/total density of trees in plot)*100
```{r}
ImportancePerPlot<-ImportancePerPlot %>% mutate(
  RelDen = (dens_in_plot/total_density)*100
)
```
### Step 2. Dominance and Relative Dominance
Begin by calculating dominance for each species

Dominance = (total of basal area/area sampled)

Calculate basal area for each tree in the trees df
To do so, calculate radius as DBH/2 and then basal area as pi*radius squared

```{r}
trees<-trees %>% mutate(
  BA = (pi*((DBH/2)*(DBH/2)))
)

```
Now get total basal area and dominance (BA/area sampled) per plot

```{r}
Dominance<-trees %>% group_by(Forest, PlotID) %>% summarize(
  TotBA = sum(BA),
  Dom = sum(BA)/APP_t
)
```
Now add to PerPlot to keep things straightforward
```{r}
PerP$TotBA = Dominance$TotBA
PerP$TotDom=Dominance$Dom
```
Now get BA and dominance per species rather than per plot
```{r}
DomPerSp<-trees %>% group_by(Forest, PlotID, Species) %>% summarize(
  BA = sum(BA),
  Dom = sum(BA)/APP_t
)
```
Now join those to ImportancePerPlot
```{r}
ImportancePerPlot<-left_join(ImportancePerPlot, DomPerSp)
```
Now join the total dominance to ImportancePerP
```{r}
ImportancePerPlot<-left_join(ImportancePerPlot, PerP, by = c("Forest", "PlotID"))
```
Now drop a couple of columns and rename a couple to keep things making sense:
```{r}
#drop unneeded variables
ImportancePerPlot<-select(ImportancePerPlot, -c(treesPerP,DensPerPlot, DensPerHect, TotBA))

```
Now I can calculate relative dominance

RelDom = (dom for a species/total dom)*100
```{r}
ImportancePerPlot<-ImportancePerPlot %>% mutate(
  RelDom = 100*(Dom/TotDom)
)
```
### Step 3. Frequency and Relative Frequency






##Seedlings/Saplings
Establish area var for seedlings/saplings
```{r}
APQ_ss<-30 #30m2 for the 3 seedling/sapling plots
```




